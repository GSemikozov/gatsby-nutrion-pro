import cx from 'classnames';
import { FastField, Form, withFormik } from 'formik';
import React from 'react';
import { useTranslation } from 'react-i18next';
import * as Yup from 'yup';

import { getCookie, getReferrer, getUTM } from '../../helpers';
import { Button } from '../button';
import styles from './form.module.css';
import heroFormStyles from './hero-ny-form.module.css';

const rePhoneNumber = /^(\+?\d{0,4})?\s?-?\s?(\(?\d{3}\)?)\s?-?\s?(\(?\d{3}\)?)\s?-?\s?(\(?\d{4}\)?)?$/

Yup.addMethod(Yup.string, "phone", function() {
  return this.test("phone", "Telefonní číslo musí obsahovat 9 znaků", value =>
    rePhoneNumber.test(value)
  )
})

export const HeroNYFormLayout = ({
  isSubmitting,
  values,
  errors,
  touched,
  themeLight,
  btnType = "primary",
  btnText = "Objednat",
}) => {
  const { t } = useTranslation()

  return (
    <Form name="akce-form" method="post" className={heroFormStyles.heroForm}>
      <div className={styles.inputField}>
        <FastField
          component="input"
          type="text"
          name="title"
          placeholder="Tvoje jméno"
          className={cx(styles.input, heroFormStyles.input)}
        />
        {touched.name && errors.name && (
          <span className={styles.error}>{errors.name}</span>
        )}
      </div>
      <div className={styles.inputField}>
        <FastField
          component="input"
          type="text"
          name="phone"
          className={cx(styles.input, heroFormStyles.input)}
        />
        {touched.phone && errors.phone && (
          <span className={cx(styles.error)}>{errors.phone}</span>
        )}
      </div>
      <Button
        name="submit"
        type={btnType}
        buttonType="submit"
        disabled={isSubmitting}
        className={heroFormStyles.button}
      >
        <svg
          fill="none"
          height="29"
          viewBox="0 0 27 29"
          width="27"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g fill="#fff">
            <path d="m5.13713 10.3293c-.20861-.1295-.33899-.1813-.57368-.41448-.23469-.23314-.91268-.44038-1.32991-.544-.20861-.05181-.26076-.28496-.18253-.44039.18253-.31085-.15646-.69943.28684-.90666.4433-.18134 1.38206-.07772 1.53852-.10362.13038-.02591.78229-.23315 1.25167-.31086.96483-.15543 1.35598-.05181 1.35598-.05181.07823 0 .13038.02591.20861.02591-.20861-.28495-.73014-.95848-.96483-1.24344-.28684-.36266-.36507-.67352-.73014-.90666-.36507-.23315-.73014-1.13981-.65191-1.65791.1043-.51809 1.01698-1.03619 1.09521-1.01028.07823.0259-1.01699.59581-.8866 1.19162.13038.59581.67799 1.42476.93875 1.52838.23469.10362-.23469-.36267-.02607-1.32115.20861-.95847.52153-1.19162.78229-1.45067.10431-.07771.23469-.20723.39115-.31085.02608-.05181.05215-.12953.10431-.18134.33899-.46628.70406-.36266.86052-.38857.15646-.0259.02608.10362-.1043.15543-.02608 0-.10431.0259-.18254.07771-.02607.07772-.20861.20724-.4433.41448-.02608.07772-.02608.12952-.02608.20724.07823.41447.05216 1.29524.339 1.21753.26076-.07772.67799-.59581.86052-.88077.18254-.28495.57369-.33676.7823-.36266.20859-.02591.70409-.18134.73019-.23315.0521-.05181.0782.07772-.1826.23315-.2607.15543-.73012.18133-.88658.33676s-.57369.72533-.75622.90667c-.18254.18133-.54761.49219-.49546.90666.05215.41448.339 1.0621.39115 1.32115s.31292.95847.75622.95847 1.51249-.10362 2.03399-.10362c.4954 0 1.5124-.07771 1.8775-.5958.3651-.5181.4172-1.52839.339-2.27963-.1043-.75124-.3912-1.83924-.2608-2.176s.4694-.67352.4955-.90667c.0261-.23314.2607-.207231.0782.20725-.1565.41447-.4433.80304-.2347 1.06209.2086.25904.5737.10362.7562-.12953.1826-.23314.4173-.85485.7302-1.08799.2868-.233147.4694-.233151.5476-.181341.0782.077714-.2869.207241-.4433.440381-.1565.25905-.4694 1.03619-.6519 1.24343-.1826.20724-.3651.36267-.4173.85486-.0521.49219-.1564 1.55429.2087 1.60609.365.05181 1.1995-.64761 1.5906-1.01028.3912-.36267.8606-.90667 1.0692-1.19162.1825-.28495.4433-.90667.4954-.72533.0522.18133-.1825.59581-.2607.80305-.0783.20724-.2869.36266-.0783.38857.2347.05181.4955-.12953.7302-.28496.2086-.15542.1304.12953-.2086.33676-.339.20724-.7823.33677-1.1996.72534-.3911.38857-1.1213.95848-1.5124 1.16572-.3912.20724-.7301.25905-.9127.51809-.1825.28496-.4954.77714.0522.95848.5476.15543 2.5033-.12952 2.9988-.44038.4954-.33676.9909-.98438.9909-1.45067s.2607 0 .2086.25905c-.0261.25905-.4172 1.1139-.9909 1.45067-.5737.36266-1.4081.49219-2.034.51809-.5997.02591-1.0952-.0259-1.3299-.05181-.2347-.0259-.5215 0-.5737.12952-.0782.15543.0522.28496.4433.31087.3912.0259 1.2778-.18134 1.4082-.31087.1303-.10361.1564.10362-.1043.23315-.2608.12952-.9388.38857-1.2778.36266-.339-.0259-.8344-.18133-1.1213-.23314-.3129-.05181-.9127-.0518-1.1995-.0518-.3129 0-1.72106-.02591-2.08613-.02591-.339.0259-.7823.18133-.99091.49219.13038.15543.15646.28495.15646.28495.15646-.10362.31292-.12953.59976-.18133.39115-.07772.54761-.05181.54761-.05181.07823.10362.05215.41447-.20861.69943-.20862.25904-.36508.46628-.73015.5699-.26076.05181-.33899.10362-.31292.20724 0 .05181-.1043.67357-.20861 1.11387h-3.10311c-.02607-.0777-.07823-.2072-.15646-.2331zm3.05096-2.95315c.18253.0259.54761-.23315.54761-.23315s-.52153-.64761-.70407-1.39885c-.15646-.75124-.4433-1.81334-.46938-2.1242 0-.20724-.1043-.5699-.05215-.90667-.18254.15543-.339.31086-.4433.49219-.39115.56991-.41723 2.22782-.20861 2.6682.18253.41448 1.14736 1.47657 1.3299 1.50248z" />
            <path d="m7.48397 13.541c-.26076 1.1916.88661 1.5284 1.40814 1.8393.52153.3367 2.76409.4662 4.58949.5699 1.8253.1036 2.0339.3108 2.7119.3626s1.0692 0 1.4603-.1554c.5476-.2072 1.0952-.1813 1.1735-.1554.026 0-.0783 0-.313.4922-.0521.1295-.1825.3108-.5476.4403-.3911.1296-.5736.0259-.6258 0 .7041.4145.9388 1.373 1.0952 2.2537.2347 1.373 1.2256 2.0983 1.5385 2.176.7563.2073 1.3039-.0259 1.6168.0259.3129.0519.4172.3886.4694.4922.0782.1037.026.2591.0782.4404.0521.1813.4172 1.0103.8344 1.5284.4173.4922 1.1996 1.1398 1.4864 1.1657.2868.0518.3651.1295.3911.2072 0 .0777.313.3368.3912.3886.1043.0518.6258-.0777.7562 0 .1565.0777.6259.6994.5998.8808-.0261.2072-.4433.1554-.6259.0518-.2086-.1036-.8344-.3368-.9909-.4663-.1564-.1295-.8344-.285-1.1213-.5181-.1825-.1554-1.043-1.0621-1.7992-1.8133.0782.3626.2346.8548.4433 1.2175.3129.5699.9648 1.3211 1.2516 1.4247.2869.1037.339.1814.339.2591s.2347.3886.3129.4663c.0783.0777.6259.0259.7563.1295.1303.1036.4693.8031.4172.9844-.0522.1813-.4433.0518-.6258-.0777-.1826-.1296-.7563-.4922-.8866-.6477-.1304-.1554-.7563-.4144-.991-.6994-.2346-.2849-1.5906-2.435-2.2425-3.1085-.652-.6995-1.5907-.544-3.2335-1.0621-1.6429-.5181-2.373-1.6061-3.0249-2.2796-.6519-.6995-3.3378-.2073-4.1983 0-.86055.2072-2.79022.1036-3.12921 0-.36508-.0778-.86053.6217-1.51244.5958-.39115 0-1.38206-.2073-2.08613-.3886.20862.2331.86053.7253 1.17345.7771.46937.0777.78229-.0259.91268.1037.05215.0518.39114.1036.5476.0777s.10431-.0777.26077-.0777.75622.4144.80837.4921c.02608.0518 0 .1296 0 .1296s-.02607.1036.05216.1554c.07822.0518.39114.6476.15645.6735-.13038.0259-.39114-.0259-.78229-.1036 0 .0259.02607.0777.05215.1036.07823.0518.36507.5181.15646.5699-.23469.0518-.99091 0-1.95574-.1295-.96483-.1554-1.40813-.544-1.59067-.6994-.18254-.1555-.4433-.4404-.99091-.8549-.5476-.4145-1.92966-1.4766-2.216503-1.9428-.286842-.4663-.2607666-.6477-.1825367-1.0103.0782297-.285.2868427-.3886.4693797-.4404 0-.0777.026075-.1813.182535-.259.365075-.1814 2.138275.0259 2.842345.1295-.83445-2.0983 1.01698-5.2846 1.40813-6.2171.26077-.6477.36507-1.1399.339-1.4507h3.07703c-.02608.1295-.05216.2331-.10431.3108-.13038.4663-.52153 1.4248-.7823 2.6423zm-4.40693 7.4088c-.20861-.1814-.52153-.4404-.83445-.7254-.31292-.1036-.52153-.1295-.52153.0518 0 .2591 1.48636 1.7616 2.5555 1.8134-.13038-.1036-.20861-.1814-.26077-.2332-.18253-.1554-.41722-.4663-.93875-.9066z" />
          </g>
        </svg>
        <span style={{ display: "inline-flex", margin: "0 8px" }}>
          Objednat
        </span>
        <svg
          fill="none"
          height="29"
          viewBox="0 0 28 29"
          width="28"
          xmlns="http://www.w3.org/2000/svg"
        >
          <g fill="#fff">
            <path d="m22.0611 10.3293c.2086-.1295.339-.1813.5737-.41448.2347-.23314.9127-.44038 1.3299-.544.2086-.05181.2608-.28496.1825-.44039-.1825-.31085.1565-.69943-.2868-.90666-.4433-.18134-1.3821-.07772-1.5385-.10362-.1304-.02591-.7823-.23315-1.2517-.31086-.9648-.15543-1.356-.05181-1.356-.05181-.0782 0-.1304.02591-.2086.02591.2086-.28495.7302-.95848.9648-1.24344.2869-.36266.3651-.67352.7302-.90666.3651-.23315.7301-1.13981.6519-1.65791-.1043-.51809-1.017-1.03619-1.0952-1.01028-.0782.0259 1.017.59581.8866 1.19162s-.678 1.42476-.9388 1.52838c-.2347.10362.2347-.36267.0261-1.32115-.2086-.95847-.5215-1.19162-.7823-1.45067-.1043-.07771-.2347-.20723-.3911-.31085-.0261-.05181-.0522-.12953-.1043-.18134-.339-.46628-.7041-.36266-.8606-.38857-.1564-.0259-.026.10362.1043.15543.0261 0 .1043.0259.1826.07771.026.07772.2086.20724.4433.41448.026.07772.026.12952.026.20724-.0782.41447-.0521 1.29524-.3389 1.21753-.2608-.07772-.678-.59581-.8606-.88077-.1825-.28495-.5737-.33676-.7823-.36266-.2086-.02591-.704-.18134-.7301-.23315-.0522-.05181-.0782.07772.1825.23315.2608.15543.7302.18133.8866.33676.1565.15543.5737.72533.7562.90667.1826.18133.5477.49219.4955.90666-.0522.41448-.339 1.0621-.3911 1.32115-.0522.25905-.313.95847-.7563.95847s-1.5124-.10362-2.0339-.10362c-.4955 0-1.5125-.07771-1.8776-.5958-.365-.5181-.4172-1.52839-.3389-2.27963.1043-.75124.3911-1.83924.2607-2.176s-.4694-.67352-.4954-.90667c-.0261-.23314-.2608-.207231-.0783.20725.1565.41447.4433.80304.2347 1.06209-.2086.25904-.5737.10362-.7562-.12953-.1825-.23314-.4172-.85485-.7301-1.08799-.2869-.233147-.4694-.233151-.5476-.181341-.0783.077714.2868.207241.4433.440381.1564.25905.4693 1.03619.6519 1.24343.1825.20724.365.36267.4172.85486.0521.49219.1565 1.55429-.2086 1.60609-.3651.05181-1.1995-.64761-1.5907-1.01028-.3911-.36267-.8605-.90667-1.0691-1.19162-.18256-.28495-.44333-.90667-.49548-.72533-.05215.18133.18253.59581.26076.80305s.28682.36266.07823.38857c-.23469.05181-.49545-.12953-.73014-.28496-.20861-.15542-.13038.12953.20861.33676.339.20724.78232.33677 1.19952.72534.3912.38857 1.1213.95848 1.5124 1.16572.3912.20724.7302.25905.9127.51809.1826.28496.4955.77714-.0521.95848-.5476.15543-2.5034-.12952-2.99883-.44038-.49546-.33676-.99091-.98438-.99091-1.45067s-.26077 0-.20861.25905c.02607.25905.41722 1.1139.9909 1.45067.57365.36266 1.40815.49219 2.03395.51809.5998.02591 1.0952-.0259 1.3299-.05181.2347-.0259.5216 0 .5737.12952.0782.15543-.0521.28496-.4433.31087-.3911.0259-1.2777-.18134-1.4081-.31087-.1304-.10361-.1565.10362.1043.23315.2608.12952.9387.38857 1.2777.36266.339-.0259.8345-.18133 1.1213-.23314.3129-.05181.9127-.0518 1.1995-.0518.313 0 1.7211-.02591 2.0862-.02591.339.0259.7823.18133.9909.49219-.1304.15543-.1565.28495-.1565.28495-.1564-.10362-.3129-.12953-.5997-.18133-.3912-.07772-.5476-.05181-.5476-.05181-.0783.10362-.0522.41447.2086.69943.2086.25904.365.46628.7301.5699.2608.05181.339.10362.3129.20724 0 .05181.1043.67357.2086 1.11387h3.1031c.0261-.0777.0783-.2072.1565-.2331zm-3.0509-2.95315c-.1826.0259-.5477-.23315-.5477-.23315s.5216-.64761.7041-1.39885c.1565-.75124.4433-1.81334.4694-2.1242 0-.20724.1043-.5699.0521-.90667.1826.15543.339.31086.4433.49219.3912.56991.4173 2.22782.2087 2.6682-.1826.41448-1.1474 1.47657-1.3299 1.50248z" />
            <path d="m19.7143 13.541c.2607 1.1916-.8866 1.5284-1.4082 1.8393-.5215.3367-2.7641.4662-4.5894.5699-1.8254.1036-2.034.3108-2.712.3626s-1.06913 0-1.46028-.1554c-.54761-.2072-1.09522-.1813-1.17345-.1554-.02607 0 .07823 0 .31292.4922.05215.1295.18254.3108.54761.4403.39115.1296.57368.0259.62584 0-.70407.4145-.93876 1.373-1.09522 2.2537-.23469 1.373-1.2256 2.0983-1.53851 2.176-.75622.2073-1.30383-.0259-1.61675.0259-.31292.0519-.41722.3886-.46938.4922-.07823.1037-.02607.2591-.07823.4404-.05215.1813-.41722 1.0103-.83445 1.5284-.41722.4922-1.19952 1.1398-1.48636 1.1657-.28684.0518-.36507.1295-.39115.2072 0 .0777-.31291.3368-.39114.3886-.10431.0518-.62584-.0777-.75622 0-.15646.0777-.625841.6994-.599764.8808.026076.2072.443304.1554.625834.0518.20861-.1036.83445-.3368.99091-.4663s.83445-.285 1.12129-.5181c.18254-.1554 1.04306-1.0621 1.79928-1.8133-.07823.3626-.23469.8548-.4433 1.2175-.31292.5699-.96483 1.3211-1.25167 1.4247-.28684.1037-.339.1814-.339.2591s-.23469.3886-.31292.4663-.62583.0259-.75621.1295c-.13039.1036-.46938.8031-.41723.9844s.4433.0518.62584-.0777c.18253-.1296.75622-.4922.8866-.6477.13038-.1554.75622-.4144.99091-.6994.23469-.2849 1.59067-2.435 2.24258-3.1085.65191-.6995 1.59067-.544 3.23349-1.0621 1.64283-.5181 2.37293-1.6061 3.02483-2.2796.652-.6995 3.3378-.2073 4.1984 0 .8605.2072 2.7902.1036 3.1292 0 .365-.0778.8605.6217 1.5124.5958.3911 0 1.3821-.2073 2.0861-.3886-.2086.2331-.8605.7253-1.1734.7771-.4694.0777-.7823-.0259-.9127.1037-.0522.0518-.3912.1036-.5476.0777-.1565-.0259-.1043-.0777-.2608-.0777-.1564 0-.7562.4144-.8083.4921-.0261.0518 0 .1296 0 .1296s.026.1036-.0522.1554-.3912.6476-.1565.6735c.1304.0259.3912-.0259.7823-.1036 0 .0259-.026.0777-.0521.1036-.0782.0518-.3651.5181-.1565.5699.2347.0518.9909 0 1.9558-.1295.9648-.1554 1.4081-.544 1.5906-.6994.1826-.1555.4433-.4404.9909-.8549s1.9297-1.4766 2.2165-1.9428c.2869-.4663.2608-.6477.1826-1.0103-.0782-.285-.2869-.3886-.4694-.4404 0-.0777-.0261-.1813-.1825-.259-.3651-.1814-2.1383.0259-2.8424.1295.8345-2.0983-1.017-5.2846-1.4081-6.2171-.2608-.6477-.3651-1.1399-.339-1.4507h-3.077c.026.1295.0521.2331.1043.3108.1304.4663.5215 1.4248.7823 2.6423zm4.4069 7.4088c.2086-.1814.5215-.4404.8345-.7254.3129-.1036.5215-.1295.5215.0518 0 .2591-1.4864 1.7616-2.5555 1.8134.1304-.1036.2086-.1814.2607-.2332.1826-.1554.4173-.4663.9388-.9066z" />
          </g>
        </svg>
      </Button>
    </Form>
  )
}

export const HeroNYForm = withFormik({
  mapPropsToValues: () => ({
    title: "",
    phone: "+420",
    referrer: "",
    ga: "",
    success: false,
  }),
  validationSchema: () =>
    Yup.object().shape({
      title: Yup.string()
        .min(1)
        .required(),
      phone: Yup.string()
        .min(9)
        .phone(),
    }),
  handleSubmit: async (
    { title, phone },
    { setSubmitting, resetForm, setFieldValue }
  ) => {
    try {
      const UTMS = getUTM()
      let referrer = getReferrer()

      const isEn = document.location.pathname.includes("/en")

      const data = {
        form_name: isEn ? "akce-form_en" : "akce-form",
        title,
        phone,
        utm_source: UTMS.UTM_SOURCE,
        utm_medium: UTMS.UTM_MEDIUM,
        utm_campaign: UTMS.UTM_CAMPAIGN,
        utm_term: UTMS.UTM_TERM,
        utm_content: UTMS.UTM_CONTENT,
        referrer: referrer,
        roistat: getCookie("roistat_visit"),
        ga: getCookie("_ga"),
      }
      await fetch("/api/application", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      })
      await setSubmitting(false)
      await setFieldValue("success", true)
      setTimeout(() => {
        resetForm()
        window.location.href = isEn ? "/en/thank-you" : "/thank-you"
        window.dataLayer.push({
          event: "ga.pageview",
          pageURL: isEn ? "/en/thank-you-contact" : "/thank-you-contact",
          pageType: "Purchase",
        })
      }, 300)
    } catch (err) {
      setSubmitting(false)
      setFieldValue("success", false)
      alert("Something went wrong, please try again!")
    }
  },
})(HeroNYFormLayout)
